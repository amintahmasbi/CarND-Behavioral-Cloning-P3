#**Behavioral Cloning** 
---
####**Behavioral Cloning Project**

The goals and steps of this project are the following:
- Use the simulator to collect data of good driving behavior
- Build, a convolution neural network in `Keras` that predicts steering angles from images
- Train and validate the model with a training and validation set
- Test that the model successfully drives around track one without leaving the road
- Summarize the results with a written report

#### Rubric Points
Here I describe how I addressed each of the ==rubric points== individually in my implementation. 

---
###Files Submitted & Code Quality

####1. Submission includes all required files and can be used to run the simulator in autonomous mode

My project includes the following files:
- **`model.py`** contains the script to create the model
- **`drive.py`** for driving the car in autonomous mode 
- **`model.h5`** containing a trained convolution neural network 
- **`run.ipynb`** __this is the main file__ which I wrote in `Jupyter Notebook` and contains the data preprocessing,  training, and check codes
- **`writeup_report.md`**  (you are reading it!) summarizes the results

####2. Submssion includes functional code
Using the Udacity provided simulator and my **`drive.py`** file (slightly modified to load weights instead of whole model), the car can be driven autonomously around the track by executing 
```sh
python drive.py model.h5 video_logs
```
The fourth argument `video_logs` is the directory to save the images seen by the car. Each image file name is a timestamp showing when the image was seen. This information is used by `video.py` to create a chronological video of the agent driving.

```sh
python video.py video_logs
```

Creates a video based on images found in the `video_logs` directory. The name of the video will be name of the directory following by `'.mp4'`.

####3. Submssion code is usable and readable

The **`model.py`** file contains the code for the convolution neural network. The  **`run.ipynb`** file shows the pipeline I used for training and validating the model, and it contains comments to explain how the code works.

###Model Architecture and Training Strategy

####1. An appropriate model arcthiecture has been employed

My model is a modified version of the *==NVIDIA End-to-End==* model, consists of a convolution neural network with same filter sizes as NVIDIA model and depths between $32$ and $128$ (code lines $40-63$). The size of hidden `Dense` layers has changed (code lines $65-83$).

All the activations are `RELU` layers to introduce nonlinearity, and `Dropout` layers are added to mitigate overfitting. The input data is normalized, cropped, and resized in the model using  `Keras` `Lambda` and `Cropping2D` layers (code line $34-39$). 


####2. Attempts to reduce overfitting in the model

The model contains `Dropout` layers after all `Dense` layers with `keep_prob = 0.5` in order to reduce overfitting.
***Random contrast*** was also introdoced to reduce overfitting. The model was trained and validated on different data sets collected, to ensure that the model was not overfitting (**`run.ipynb`** ). The model was tested by running it through the simulator and ensuring that the vehicle could stay on the track. I never trained or tested the model on track 2.

####3. Model parameter tuning

The model is trained using an Adam optimizer, The learning rate was tuned manually two times (`lr=0.001` and `lr=0.0001` in **`run.ipynb`**). I reduced the value after the first $5$ training epochs to fine-tune the learning and make convegance smoother.

####4. Appropriate training data

The main training data was chosen from the center driving data which kept the vehicle driving on the center of the road. I used a combination of center, left and right  images, to recover from the left and right shifts by adding and reducing **0.25** to the left and right images, respectively.

###Model Architecture and Training Strategy

####1. Solution Design Approach

The overall strategy for deriving a model architecture was to use a model proved to be working for such applications.

My first step was to use a convolution neural network model similar to the *NVIDIA End-to-End* model. I thought this model might be appropriate because it has been tested in real world. I then increased the size of the last convolutional layer from $64$ to $128$ to infere more from the images, since I used smaller images with size of $(64,128,3)$. Then, for the same reason, I increased the size of fully connected layers to $512$, $64$, and $16$.

I started out by picking three images from the `driving_log.csv' file, one with negative, one with straight, and one with positive steering. I trained the model with just those three images and I could overfit to predict them correctly!  Then I started adding more training data loading same weights as a starting point for my next training session (kinda like Transfer Learning). 

At the end of the process, the vehicle is able to drive autonomously around the track without leaving the road.

####2. Final Model Architecture

Here is a visualization of the architecture I used:
____________________________________________________________________________________________________
    Layer (type)                     Output Shape          Param #     Connected to
    ====================================================================================================
    lambda_1 (Lambda)                (None, 160, 320, 3)   0           lambda_input_1[0][0]
    ____________________________________________________________________________________________________
    lambda_2 (Lambda)                (None, 160, 320, 3)   0           lambda_1[0][0]
    ____________________________________________________________________________________________________
    cropping2d_1 (Cropping2D)        (None, 105, 320, 3)   0           lambda_2[0][0]
    ____________________________________________________________________________________________________
    lambda_3 (Lambda)                (None, 64, 128, 3)    0           cropping2d_1[0][0]
    ____________________________________________________________________________________________________
    convolution2d_1 (Convolution2D)  (None, 64, 128, 3)    12          lambda_3[0][0]
    ____________________________________________________________________________________________________
    convolution2d_2 (Convolution2D)  (None, 30, 62, 24)    1824        convolution2d_1[0][0]
    ____________________________________________________________________________________________________
    activation_1 (Activation)        (None, 30, 62, 24)    0           convolution2d_2[0][0]
    ____________________________________________________________________________________________________
    convolution2d_3 (Convolution2D)  (None, 13, 29, 36)    21636       activation_1[0][0]
    ____________________________________________________________________________________________________
    activation_2 (Activation)        (None, 13, 29, 36)    0           convolution2d_3[0][0]
    ____________________________________________________________________________________________________
    convolution2d_4 (Convolution2D)  (None, 5, 13, 48)     43248       activation_2[0][0]
    ____________________________________________________________________________________________________
    activation_3 (Activation)        (None, 5, 13, 48)     0           convolution2d_4[0][0]
    ____________________________________________________________________________________________________
    convolution2d_5 (Convolution2D)  (None, 3, 11, 64)     27712       activation_3[0][0]
    ____________________________________________________________________________________________________
    activation_4 (Activation)        (None, 3, 11, 64)     0           convolution2d_5[0][0]
    ____________________________________________________________________________________________________
    convolution2d_6 (Convolution2D)  (None, 1, 9, 128)     73856       activation_4[0][0]
    ____________________________________________________________________________________________________
    activation_5 (Activation)        (None, 1, 9, 128)     0           convolution2d_6[0][0]
    ____________________________________________________________________________________________________
    flatten_1 (Flatten)              (None, 1152)          0           activation_5[0][0]
    ____________________________________________________________________________________________________
    FC1 (Dense)                      (None, 512)           590336      flatten_1[0][0]
    ____________________________________________________________________________________________________
    activation_6 (Activation)        (None, 512)           0           FC1[0][0]
    ____________________________________________________________________________________________________
    dropout_1 (Dropout)              (None, 512)           0           activation_6[0][0]
    ____________________________________________________________________________________________________
    FC2 (Dense)                      (None, 64)            32832       dropout_1[0][0]
    ____________________________________________________________________________________________________
    activation_7 (Activation)        (None, 64)            0           FC2[0][0]
    ____________________________________________________________________________________________________
    dropout_2 (Dropout)              (None, 64)            0           activation_7[0][0]
    ____________________________________________________________________________________________________
    FC3 (Dense)                      (None, 16)            1040        dropout_2[0][0]
    ____________________________________________________________________________________________________
    activation_8 (Activation)        (None, 16)            0           FC3[0][0]
    ____________________________________________________________________________________________________
    dropout_3 (Dropout)              (None, 16)            0           activation_8[0][0]
    ____________________________________________________________________________________________________
    y_pred (Dense)                   (None, 1)             17          dropout_3[0][0]
    ====================================================================================================
    Total params: 792,513
    Trainable params: 792,513
    Non-trainable params: 0

####3. Creation of the Training Set & Training Process

To capture good driving behavior, I first recorded three laps on track 1 using center lane driving. Then I drove the same track backward and collected data for that. I then recorded the vehicle recovering from the left side and right sides of the road back to center, so that the vehicle would learn to steer back to the road. I also used the left and right images for the same purpose, too. I also used the Udacity provided data for training my model. I never used data from track 2 though.

The processing steps are:
- Find the full path to the `driving_log.csv` file 
- *`read_frames_and_steering_from_file`* function in (**`run.ipynb`** ) converts the file to a `pandas` _DataFrame_ and drops any line that has a steering value or throttle value less than the specified thresholds.
- `train_generator` and `validation_generator` are selecting random samples from the _DataFrame_ for trainig and validation.
 
Here is the code where I read the file and process it: 
```python
img_size = (160,320)
batch_sample_size = 200

script_dir = os.getcwd()

train_data_dir_name = "data"
train_data_dir = os.path.join(script_dir, train_data_dir_name)

driving_log_file_data = read_frames_and_steering_from_file\
(train_data_dir,"driving_log.csv",throttle_drop_value=0.25,steering_drop_value=0.05)


train_generator = generate_train_data(train_data_dir,driving_log_file_data,batch_size=batch_sample_size)
validation_generator = generate_validation_data(train_data_dir,driving_log_file_data)
```
Any entry in the log file with a throttle value less than $0.25$ is dropped from _DataFrame_. Also,
1. For the first round of training (first $5$ epochs), I dropped the steering values less than $0.15$
2. For the next $5$ epochs, I dropped the steering less than $0.10$
3. For the final $5$ epochs, the steering drop threshold is set to $0.05$

Here is the image of all of the steering values for the final training step.

![all text][steeringvalues]

To augment the data set, in addition to random contrast and driving backward, I also flipped images and angles randomly in my training generator. 

Here is a random sample of flipping:


![all text][image6]  ![all text][image7]


After the collection process, I have approximately $13000$ number of data points ($\times3$ images). This data is passed through above mentioned filters and got randomly shuffled. A part of the center images without flipping is used for validation. 

I used an Adam optimizer and manually changed the learning rate. Learning rate of $0.001$ is used for the first $5$ epochs, then I changed it to $0.0001$ for the rest of the training.

```python
#%%loading previously existing weights if exists and compiling the model

model_file_name = 'model.h5'
model= None
    
if os.path.exists(model_file_name):
    model = create_model(img_size)
    model.load_weights(model_file_name)
else:
    model = create_model(img_size)
        
model.compile(optimizer=Adam(lr=0.0001),loss='mean_squared_error')

print (model.summary()) 
```

I visualized the middle layer convolutions to track the learning of my algorithm and check the perception of my model on random images before and after training. Here is a sample of a random image passed through the model and the size and images of the outputs from the $12-th$ layer.



![all text][image1]


    (1, 3, 11, 64)



![all text][image2]

Here is the training part of the model. I used the created generators for _fit_generator_ function.


```python
nb_epoch=5
train_samples_per_epoch=40000
val_samples_per_epoch = len_plt

history = model.fit_generator(train_generator,samples_per_epoch=train_samples_per_epoch, nb_epoch=nb_epoch,\
                    verbose=1,validation_data = validation_generator,nb_val_samples=val_samples_per_epoch)

model.save_weights(model_file_name)


```

The learning progress of the last training phase...


    Epoch 1/5
    40000/40000 [==============================] - 141s - loss: 0.0254 - val_loss: 0.0146
    Epoch 2/5
    40000/40000 [==============================] - 129s - loss: 0.0236 - val_loss: 0.0138
    Epoch 3/5
    40000/40000 [==============================] - 129s - loss: 0.0215 - val_loss: 0.0131
    Epoch 4/5
    40000/40000 [==============================] - 130s - loss: 0.0204 - val_loss: 0.0126
    Epoch 5/5
    40000/40000 [==============================] - 130s - loss: 0.0192 - val_loss: 0.0112


Here is the output of same image passed through the model after training for the $12-th$ layer.

```python
plt.imshow(input_image[0])
plt.title("{}".format(output_str))
plt.show()
out_layer_idx = 12
output = get_activations(model, out_layer_idx, input_image)
print(output[0].shape)
visualizing_activations(output[0],8,8).show()
```

![all text][image3]


    (1, 3, 11, 64)



![all text][image4]


#### Model evaluation
I finally plotted the loss of training to track the trend of the learning. I predicted few steering values for images to evaluate the model performance.
![all text][image5]


    pred:-0.14350590109825134 actual:-0.13082890212535858
    pred:-0.5284291505813599 actual:-0.3404655009508133
    pred:0.010480041615664959 actual:0.09773462265729904
    pred:-0.08113003522157669 actual:0.09255479276180267
    pred:-0.04035795480012894 actual:-0.03514359891414642
    pred:-0.1151411309838295 actual:-0.16701379418373108
    pred:-0.1510857790708542 actual:0.09255479276180267
    pred:0.34376421570777893 actual:0.378739595413208
    pred:0.4526773989200592 actual:0.3404655009508133
    pred:0.07950524985790253 actual:0.16701379418373108
    pred:-0.3010057508945465 actual:-0.378739595413208
    pred:0.07847671210765839 actual:0.128739595413208
    pred:0.22050225734710693 actual:0.5784605741500854

[//]: # (Image References)
[steeringvalues]:./images/output_5_0.png "Steering Values"
[image1]: ./images/output_7_0.png "Random Image"
[image2]: ./images/output_7_2.png "Model Middle Output"
[image3]: ./images/output_9_0.png "Same Image"
[image4]: ./images/output_9_2.png "Same Middle Output"
[image5]: ./images/output_10_1.png "Loss Graph"
[image6]: ./images/output_11_0.png "Another Random"
[image7]: ./images/output_11_1.png "Another Flipped"